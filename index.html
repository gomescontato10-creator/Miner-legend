<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MINER LEGEND: TRADES & CODES</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --bg: #050508; --p: #12121a; --gold: #ffcc00; --acc: #00ff88; --hp: #ff4444; }
        * { box-sizing: border-box; font-family: 'Arial', sans-serif; color: #fff; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #auth { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .in-auth { background: #111; border: 1px solid #333; padding: 12px; border-radius: 8px; margin: 5px; width: 260px; }
        header { background: var(--p); padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-bottom: 2px solid #333; }
        .stat { background: #000; padding: 8px; border-radius: 8px; text-align: center; border: 1px solid #222; }
        .stat b { color: var(--gold); font-size: 18px; display: block; }
        .auto-zone { background: #1a1a24; padding: 8px; display: flex; justify-content: center; align-items: center; gap: 10px; border-bottom: 1px solid #333; }
        nav { display: flex; background: #000; border-bottom: 2px solid #222; overflow-x: auto; }
        .nav-btn { flex: 1; min-width: 80px; padding: 15px 5px; text-align: center; font-size: 10px; font-weight: bold; cursor: pointer; color: #666; }
        .nav-btn.active { color: var(--acc); border-bottom: 3px solid var(--acc); background: #111; }
        .main { flex: 1; overflow-y: auto; padding-bottom: 30px; }
        .tab { display: none; padding: 20px; flex-direction: column; align-items: center; }
        .tab.active { display: flex; }
        .rock { width: 130px; height: 130px; background: #4e342e; border-radius: 30px; border: 4px solid #222; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 50px; box-shadow: 0 8px 0 #000; transition: 0.05s; }
        .rock:active { transform: translateY(4px); box-shadow: 0 4px 0 #000; }
        .hp-box { width: 100%; max-width: 280px; height: 20px; background: #000; border-radius: 10px; border: 1px solid #444; overflow: hidden; margin-top: 15px; position: relative; }
        .hp-bar { height: 100%; background: var(--hp); transition: width 0.05s; }
        .hp-txt { position: absolute; inset: 0; text-align: center; font-size: 12px; line-height: 18px; font-weight: bold; }
        .card { width: 100%; max-width: 400px; background: var(--p); padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #222; }
        .buy-btn { background: var(--acc); color: #000; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .buy-btn:disabled { background: #333; color: #777; }
        #chat-box { width: 100%; height: 150px; background: #000; padding: 10px; overflow-y: auto; border: 1px solid #222; border-radius: 8px; margin-bottom: 8px; font-size: 12px; }
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #222; width: 100%; }
        .trade-btn { background: #0088ff; color: #fff; border: none; padding: 5px 8px; border-radius: 5px; font-size: 10px; }
    </style>
</head>
<body>

<div id="auth">
    <h1 style="color:var(--gold)">MINER LEGEND</h1>
    <input type="text" id="user" class="in-auth" placeholder="Nick">
    <input type="password" id="pass" class="in-auth" placeholder="Senha">
    <button class="buy-btn" style="width:260px; margin-top:10px;" onclick="game.login()">ENTRAR</button>
</div>

<header>
    <div class="stat"><small>OURO</small><b id="u-gold">0</b></div>
    <div class="stat"><small>DANO</small><b id="u-dmg">1</b></div>
</header>

<div class="auto-zone">
    <label style="font-size: 11px; color: var(--acc);"><input type="checkbox" id="auto-check" onchange="game.toggleAuto()"> AUTO CLICKER</label>
</div>

<nav>
    <div class="nav-btn active" onclick="game.tab('mina', this)">MINA</div>
    <div class="nav-btn" onclick="game.tab('loja', this)">LOJA</div>
    <div class="nav-btn" onclick="game.tab('pets', this)">PETS</div>
    <div class="nav-btn" onclick="game.tab('codes', this)">C√ìDIGOS</div>
    <div class="nav-btn" onclick="game.tab('rank', this)">RANK</div>
</nav>

<div class="main">
    <div id="mina" class="tab active">
        <h3 id="p-name" style="margin:0; color:var(--acc)">...</h3>
        <div class="rock" onclick="game.mine(true)">‚õèÔ∏è</div>
        <div class="hp-box"><div id="hp-bar" class="hp-bar"></div><div id="hp-txt" class="hp-txt">0/0</div></div>
    </div>

    <div id="loja" class="tab"><div id="pick-list" style="width:100%"></div></div>
    <div id="pets" class="tab"><div id="pet-list" style="width:100%"></div></div>

    <div id="codes" class="tab">
        <h3>RESGATAR C√ìDIGO</h3>
        <input type="text" id="code-in" class="in-auth" placeholder="Digite aqui...">
        <button class="buy-btn" onclick="game.useCode()">RESGATAR</button>
    </div>

    <div id="rank" class="tab">
        <div id="rank-list" style="width:100%; background:#111; border-radius:8px; margin-bottom:10px;"></div>
        <div id="chat-box"></div>
        <div style="display:flex; gap:5px; width:100%;">
            <input type="text" id="chat-in" placeholder="Mensagem..." style="flex:1; background:#000; border:1px solid #333; padding:10px; border-radius:5px;">
            <button class="buy-btn" onclick="game.sendChat()">OK</button>
        </div>
    </div>
</div>

<script>
const ABLY_KEY = 'wpgTTw.ROsKoQ:3G5iFq9cMkZppCZ4aicBOwDhAGs69lV0Egd55FistlQ';

const game = {
    gold: 0, pIdx: 0, myPets: {}, curHp: 10, maxHp: 10, nick: "", usedCodes: [],
    suffixes: ["", "K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"],
    picks: ["Madeira", "Pedra", "Ferro", "A√ßo", "Ouro", "Platina", "Esmeralda", "Diamante", "Rubi", "Obsidiana", "Mithril", "Adamantio", "Netherite", "Vibranium", "Estelar", "Solar", "Lunar", "Vazio", "Abissal", "Celestial", "Divina", "Eterna", "Infinitum", "Quantum", "Gal√°tica", "Nebulosa", "M√≠stica", "R√∫nica", "Ancestral", "Tit√¢nica", "Vulc√¢nica", "Glacial", "Rel√¢mpago", "Drag√£o", "F√™nix", "Caos", "Luz", "Sombra", "Destrui√ß√£o", "Cria√ß√£o", "Realidade", "Tempo", "Espa√ßo", "Multiverso", "Omni", "Deus", "Z√™nite", "Final", "Infinito", "Lend√°ria"],

    f(n) {
        if (n < 1000) return Math.floor(n);
        let e = Math.floor(Math.log10(n) / 3);
        return (n / Math.pow(1000, e)).toFixed(1) + this.suffixes[e];
    },

    login() {
        this.nick = document.getElementById('user').value;
        if(!this.nick) return;
        let s = JSON.parse(localStorage.getItem('save_'+this.nick));
        if(s) { this.gold=s.gold; this.pIdx=s.pIdx; this.myPets=s.myPets||{}; this.maxHp=s.maxHp; this.usedCodes=s.usedCodes||[]; }
        document.getElementById('auth').style.display='none';
        this.initNet(); this.update(); this.render();
    },

    getDmg() {
        let d = 10 * Math.pow(2.0, this.pIdx);
        let m = 1;
        Object.keys(this.myPets).forEach(i => {
            // Se for o pet do c√≥digo 67 (√≠ndice 99) ele d√° 10x
            let mult = (i == 99) ? 10 : (parseInt(i) + 2);
            m += mult * this.myPets[i];
        });
        return d * m;
    },

    mine(manual) {
        this.curHp -= this.getDmg();
        if(this.curHp <= 0) {
            this.gold += (60 * Math.pow(2.0, this.pIdx));
            this.maxHp *= 1.10;
            this.curHp = this.maxHp;
            this.save(); this.sync();
        }
        this.update();
    },

    useCode() {
        let val = document.getElementById('code-in').value;
        if(val === "67" && !this.usedCodes.includes("67")) {
            this.myPets[99] = (this.myPets[99] || 0) + 1; // Pet 10x
            this.usedCodes.push("67");
            alert("C√ìDIGO ACEITO! Voc√™ ganhou um Pet Lend√°rio 10x!");
            this.save(); this.render(); this.update();
        } else {
            alert("C√≥digo inv√°lido ou j√° usado!");
        }
        document.getElementById('code-in').value = "";
    },

    trade(target) {
        let amount = parseFloat(prompt(`Quanto ouro enviar para ${target}?`));
        if(amount > 0 && this.gold >= amount) {
            this.gold -= amount;
            this.channel.publish('trade', {from: this.nick, to: target, val: amount});
            this.save(); this.update();
            alert(`Voc√™ enviou ${this.f(amount)} de ouro!`);
        }
    },

    update() {
        document.getElementById('u-gold').innerText = this.f(this.gold);
        document.getElementById('u-dmg').innerText = this.f(this.getDmg());
        document.getElementById('hp-bar').style.width = (this.curHp/this.maxHp*100) + "%";
        document.getElementById('hp-txt').innerText = `${this.f(this.curHp)} / ${this.f(this.maxHp)}`;
        document.getElementById('p-name').innerText = "Picareta: " + this.picks[this.pIdx];
    },

    render() {
        let l = document.getElementById('pick-list'), p = document.getElementById('pet-list');
        l.innerHTML = ""; p.innerHTML = "";
        for(let i=0; i<=this.pIdx+1; i++) {
            let cost = 100 * Math.pow(2.5, i);
            l.innerHTML += `<div class="card"><div><b>${this.picks[i]}</b><br><small>Dano: ${this.f(10*Math.pow(2.0,i))}</small></div><button class="buy-btn" onclick="game.buyP(${i},${cost})" ${this.gold<cost?'disabled':''}>${i<=this.pIdx?'OK':'üí∞'+this.f(cost)}</button></div>`;
        }
        // Exibir Pet do C√≥digo se tiver
        if(this.myPets[99]) {
            p.innerHTML += `<div class="card" style="border-color:gold"><div><b>PET LEND√ÅRIO (C√≥d 67)</b><br><small>B√¥nus: x10.0</small></div><span>Qtd: ${this.myPets[99]}</span></div>`;
        }
        for(let i=0; i<10; i++) {
            let cost = 500 * Math.pow(4, i);
            p.innerHTML += `<div class="card"><div><b>Pet #${i+1}</b><br><small>Mult: x${i+2}</small></div><button class="buy-btn" onclick="game.buyPet(${i},${cost})" ${this.gold<cost?'disabled':''}>üí∞${this.f(cost)}</button></div>`;
        }
    },

    buyP(i, c) { if(this.gold>=c && i>this.pIdx){this.gold-=c; this.pIdx=i; this.save(); this.render(); this.update();}},
    buyPet(i, c) { if(this.gold>=c){this.gold-=c; this.myPets[i]=(this.myPets[i]||0)+1; this.save(); this.render(); this.update();}},
    tab(id, b) {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
        document.getElementById(id).classList.add('active'); b.classList.add('active');
    },
    toggleAuto() { clearInterval(this.loop); if(document.getElementById('auto-check').checked) this.loop=setInterval(()=>this.mine(false), 40); },
    save() { localStorage.setItem('save_'+this.nick, JSON.stringify({gold:this.gold, pIdx:this.pIdx, myPets:this.myPets, maxHp:this.maxHp, usedCodes:this.usedCodes})); },
    
    channel: null, players: {},
    initNet() {
        const ably = new Ably.Realtime(ABLY_KEY);
        this.channel = ably.channels.get('global');
        this.channel.subscribe('upd', m => {
            this.players[m.data.n] = m.data.g;
            let h = "";
            Object.entries(this.players).sort((a,b)=>b[1]-a[1]).forEach(([n,g])=>{
                h += `<div class="rank-item"><span>${n}: üí∞${this.f(g)}</span> ${n!=this.nick?`<button class="trade-btn" onclick="game.trade('${n}')">Trocar</button>`:''}</div>`;
            });
            document.getElementById('rank-list').innerHTML = h;
        });
        this.channel.subscribe('trade', m => {
            if(m.data.to === this.nick) {
                this.gold += m.data.val;
                alert(`Voc√™ recebeu ${this.f(m.data.val)} de ouro de ${m.data.from}!`);
                this.save(); this.update();
            }
        });
        this.channel.subscribe('chat', m => {
            let c = document.getElementById('chat-box');
            c.innerHTML += `<div><b>${m.data.n}:</b> ${m.data.t}</div>`;
            c.scrollTop = c.scrollHeight;
        });
        this.sync();
    },
    sync() { if(this.channel) this.channel.publish('upd', {n:this.nick, g:this.gold}); },
    sendChat() { let i=document.getElementById('chat-in'); if(i.value && this.channel){this.channel.publish('chat',{n:this.nick,t:i.value}); i.value="";}}
};
</script>
</body>
</html>
